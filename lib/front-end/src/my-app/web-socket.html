<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<dom-module id="web-socket">
  <script>
    class WebSocketElement extends Polymer.Element {
      static get is() { return 'web-socket'; }
      static get properties() {
        return {
          socket: {
            type: Object
          },
          url: {
            type: String
          },
          message: {
            type: String
          },
          response: {
            type: Object,
            notify: true
          },
          notResponse: {
            type: Number,
            value: 0
          },
          timer: Object
        }
      }

      ready() {
        super.ready();
        this.socket = new WebSocket(this.url);
      }

      generateRequest() {
        var that = this;
        if(this.socket==undefined){
          setTimeout(function(){
            that.generateRequest()
          },300)
        } else {
          this.socket.onerror = this.onError.bind(this);
          this.socket.onclose = this.onClosed.bind(this);
          this.socket.onopen = function() {console.log('open')}
          this.onSend();
          this.socket.send(that.message);
          this.socket.onmessage = function(event) {
            that.response = JSON.parse(event.data);
          }
          this.socket.onmessage = this.onResponse.bind(this);
        }
      }

      onResponse(event) {
        clearInterval(this.timer);
        var data = JSON.parse(event.data);
        this.dispatchEvent(new CustomEvent('response', {detail: data}));
      }

      onError(event) {
        clearInterval(this.timer);
        var data = 'Server is do not respond';
        this.dispatchEvent(new CustomEvent('error', {detail: data}));
      }

      onClosed(event) {
        var data = event;
        this.dispatchEvent(new CustomEvent('closed', {detail: data}));
      }

      onSend() {
        this.notResponse = 0;
        var that = this;
        this.timer = setInterval(function(){
          if (that.notResponse>5) that.onError();
          else that.notResponse++
        }, 1000)
        var data = 'Try send message';
        this.dispatchEvent(new CustomEvent('send', {detail: data}));
      }

    }
    window.customElements.define(WebSocketElement.is, WebSocketElement);
  </script>
</dom-module>
