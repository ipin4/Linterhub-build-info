<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-behaviors/paper-button-behavior.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">



<link rel="import" href="shared-styles.html">

<dom-module id="config-builder">
  <template>
    <style include="shared-styles">
      :host{
        --primary-color: var(--paper-grey-900);
      }
      paper-dropdown-menu.custom {
        width: 13em;    
        --paper-input-container-label: {
          text-transform: capitalize;
          color: var(--paper-grey-400);
        };
      }
      paper-input {
        display: inline-block;
        --paper-input-container-label: {
            text-transform: capitalize;
            color: var(--paper-grey-400);
        };
        width: 13em;
      }
      paper-checkbox {
          margin: .7em 0;
      }
      .devider {
        width: 100%;
        height: 2em;
        color: var(--paper-grey-800);
        text-align: center;
        text-transform: uppercase;
        line-height: 2em;
        background-color: #e0e0e0;
      }
      .undercover {
        padding: 1em;
        transition: background-color .7s;
      }
      .undercover:hover {
        background-color: #fff !important;
        transition: background-color .3s;
      }
      .undercover:nth-child(odd) {
        background-color: rgba(255,255,255,.5);
      }
      .container {  
        margin: .3em .5em;
      }
      .item-name {
        text-transform: capitalize;
        font-weight: bold ;
      }
      .description {
        padding: .2em 0;
        font-size: .9em
      }
      paper-button {
        margin: .7em 0;
        border: .09em solid var(--paper-grey-400);
      }
      .line {
        text-align: right;
        border-top: .1em solid var(--paper-grey-500);
        background-color: var(--paper-grey-300);
      }
      .input-block {
        display: block;
      }
    </style>
    
    <iron-ajax
        id="setConfig"
        url="{{url}}"
        handle-as="json"
        loading="{{loading}}"
        on-response="_dataConverter"
        last-response="{{response}}"></iron-ajax>

      <array-selector id="inputArraySelector" items="{{itemsNumber}}" selected="{{inputArrayItems}}" multi></array-selector>
          
      <div class="devider">
        <p>[[response.title]]</p>
      </div>  

        <template is="dom-repeat" items="[[ajaxContent]]">
          <div class="undercover">
            <template is="dom-if" if="[[getDropdown(item.enum)]]">
              <div class="container">
                <div class="item-name">[[item.key]]</div>
                <div class="description">[[item.description]]</div>
                <paper-dropdown-menu class="custom" label="[[item.key]]" on-iron-select="dropdownChanged" horizontal-align="left">
                  <paper-listbox slot="dropdown-content" class="dropdown-content">
                    <template is="dom-repeat" items="[[item.enum]]">
                      <paper-item>[[item]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
            </template>
            <template is="dom-if" if="[[!getSwitch(item.type)]]">
              <div class="container">
                <div class="item-name">[[item.key]]</div>
                <div class="description">[[item.description]]</div>
                <paper-checkbox name="[[item.key]]" checked="[[getSwitch(item.type)]]" on-change="checkboxChanged"></paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="[[getTextInput(item.type, item.enum)]]">
              <div class="container">
                <div class="item-name">[[item.key]]</div>
                <div class="description">[[item.description]]</div>
                <paper-input always-float-label label="[[item.key]]" on-blur="inputChanged"></paper-input>
              </div>
            </template>
            <template is="dom-if" if="[[getTextArray(item.type)]]">
              <div class="container">
                <div class="item-name">[[item.key]]</div>
                <div class="description">[[item.description]]</div>
                <paper-icon-button icon="add-circle" drawer-toggle on-click="addInput"></paper-icon-button>
                <span>Add Input field</span>
                <template is="dom-repeat" items="[[inputArrayItems]]" as="inputId" id="[[item.key]]">
                  <div class="input-block" id="[[inputId]]">
                    <paper-input class="array" id="[[inputId]]" always-float-label label="[[item.key]]" on-blur="inputArrayChanged"></paper-input>
                    <paper-icon-button icon="clear" drawer-toggle on-click="removeInput"></paper-icon-button>
                  </div>
                </template>
                

              </div>
            </template>
          </div>
        </template>
        <div class="undercover line">
            <div class="container">
                <div class="item-name">Save</div>
                <div class="description">Click to save your config</div>
                <paper-button on-click="getUserConfig">Save Config</paper-button>
            </div>
        </div>
        
  </template>
  <script>
    class configBuilder extends Polymer.Element {
      static get is() { return 'config-builder'; }
      static get properties() {
        return {
            url: {
              type: String,
              observer: '_gotUrl'
            },
            ajaxContent: {
              type: Array,
              value: [],
              notify: true
            },
            response: {
              type: Object
            },
            userConfig: {
              type: Object,
              value: {
                name: '',
                options: {
                  
                }
              }
            },
            itemsNumber: {
              type: Array,
              value: [],
              notify: true
            },
            counter: {
              type: Number,
              value: 0
            }
         }
      }

      _gotUrl() {
        this.$.setConfig.generateRequest();
      }

      _dataConverter() {
        this.userConfig.name = this.response.title.split(' ')[0];
        let obj = this.response.definitions.options.properties;
        let array = [];
        for (var index in obj) {
          if (index!='') {
            (index != '-version') ? obj[index].key = index.replace('--', '') : obj[index].key = index.replace('-', '')
          } else {
            obj[index].key = 'path';
          }
          if (obj[index].oneOf != undefined) {
            let data = obj[index];
            data.enum = data.oneOf[0].enum;
          }
          array.push(obj[index]);
        }
        this.ajaxContent = array.slice();
      }

      getDropdown(type) {
        if (type !== undefined) {
            return true
        } else {
            return false
        }
      }
      
      getSwitch(type) {
        if (type + '' == 'null') {
          return false
        } else {
          return true
        }
      }

      getTextInput(type, notDropdown) {
        if (type == 'string' && notDropdown == undefined) {
          return true
        } else {
          return false
        }
      }

      getTextArray(type) {
        if (type == 'array') {
          return true 
        } else {
          return false
        }
      }

      dropdownChanged(e) {
        let node = e.target;
        this.userConfig.options['--' + node.parentNode.label] = node.selectedItem.innerText;
      }

      checkboxChanged(e) {
        let node = e.target;
        if (node.checked) {
          node.innerHTML = 'null';
          this.userConfig.options['--' + node.name] = 'null';
        } else {
          node.innerHTML = '';
          delete this.userConfig.options['--' + node.name];
        }
      }

      inputChanged(e) {
        var node = e.target;
        if (node.value == undefined || e.key == 'Tab') return
        this.userConfig.options['--' + node.label] = node.value;
        if (node.value == '') {
          delete this.userConfig.options['--' + node.label];
        }
      }

      inputArrayChanged(e) {
        let node = e.target;
        if (node.value == undefined || e.key == 'Tab') return
        if (this.userConfig.options['--' + node.label] == undefined) {
          this.userConfig.options['--' + node.label] = new Array();
        }
        this.userConfig.options['--' + node.label] = [];
        let allInputs = node.parentNode.parentNode.querySelectorAll('div.input-block');
        for (let index = 0; index < allInputs.length; index++) {
          this.userConfig.options['--' + node.label].push(allInputs[index].childNodes[1].value) 
        }

      }

      addInput(e) {
        this.counter++;
        let indexName = 'input_' + this.counter;
        this.itemsNumber.push(indexName);
        this.$.inputArraySelector.select(indexName)
      }

      removeInput(e) {
        let node = e.target;
        let label = e.target.previousSibling.previousSibling.label;

        this.itemsNumber.forEach((element, elementIndex) => {
          if (element == node.parentNode.id) {
            if (this.userConfig.options['--' + label] !== undefined) {
              this.userConfig.options['--' + label].splice(elementIndex, 1);
            }
            this.itemsNumber.splice(elementIndex, 1);
            this.$.inputArraySelector.deselect(element);
          }
        })
        if (this.userConfig.options['--' + label] === undefined || this.userConfig.options['--' + label][0] === undefined) {
          delete this.userConfig.options['--' + label];
        }
        let allInputs = node.parentNode.parentNode.querySelectorAll('div.input-block');
        for (let index = 0; index < allInputs.length-1; index++) {
          if (this.userConfig.options['--' + label] !== undefined) {
            allInputs[index].childNodes[1].value = this.userConfig.options['--' + label][index]
          }
        }
      }

      getUserConfig() {
        console.log(this.userConfig)
      }

    }
    window.customElements.define(configBuilder.is, configBuilder);
  </script>
</dom-module>
