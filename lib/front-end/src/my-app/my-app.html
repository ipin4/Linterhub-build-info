<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="data-header.html">
<link rel="import" href="job-log.html">
<link rel="import" href="view-config.html">
<link rel="import" href="error-page.html">

<dom-module id="my-app">
  <template>
    <style>
      paper-tabs {
        --paper-tabs-selection-bar-color: var(--paper-grey-900);
        --paper-tab-ink: var(--paper-grey-900);
        -webkit-font-smoothing: antialiased;
        width: 80%;
        margin: 0 auto;
      }
      paper-tab[link] a {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        color: var(--paper-grey-900);
        text-transform: uppercase;
        text-decoration: none;
      }
      .header {
        width: 100%;
        height: 4em;
        background-color: rgb(230,230,230);
        margin-bottom: 2em;
      }
      .header img {
        height: 56%;
        width: auto;
        margin: .55em .8em 0 0;
        float: left;
      }
      .header p {
        display: inline-block;
        font-size: 1.3em;
        font-weight: 400;
        margin-top: .85em;
      }
      .container {
        width: 80%;
        height: 5em;
        margin: 0 auto;
      }
      .spinner-container {
        position: absolute;
        top: 0;
        left: -6em;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .cfg {
        left: -9em;
      }
      paper-spinner-lite {
        --paper-spinner-color: var(--paper-grey-900);
        --paper-spinner-stroke-width: 2px;
        width: 1em;
        height: 1em;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <div class="header">
      <div class="container">
        <img src="../../data/images/logo.png" alt="">
        <p>Linterhub build info</p>
      </div>
    </div>

    <data-header></data-header>

    <nav>
      <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
        <paper-tabs selected="[[page]]" attr-for-selected="name">
            <paper-tab link name="job-log">
              <div hidden$="[[jobAnswer]]" class="spinner-container">
                <paper-spinner-lite active={{!jobAnswer}}></paper-spinner-lite>
              </div>
              <a name="job-log" href="/job-log">Job log</a>
            </paper-tab>
            <paper-tab link name="view-config">
              <div hidden$="[[cfgAnswer]]" class="spinner-container cfg">
                <paper-spinner-lite active={{!cfgAnswer}}></paper-spinner-lite>
              </div>
              <a name="view-config" href="/view-config">View config</a>
            </paper-tab>
        </paper-tabs>
      </iron-selector>
    </nav>

    <section>
      <iron-pages
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="view404"
          role="main">
        <job-log
            id="jobLog"
            name="job-log"
            responsed="{{jobAnswer}}"></job-log>
        <view-config
            name="view-config"
            id="viewConfig"
            responsed="{{cfgAnswer}}"></view-config>
        <error-page name="view404">Error 404. Page  not found.</error-page>
      </iron-pages>
    </section>

  </template>

  <script>
    class MainPage extends Polymer.Element {
      static get is() { return 'my-app'; }
      static get properties() {
        return {
          page: {
            type: String,
            observer: '_pageChanged',
          },
          connected: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      _routePageChanged(page) {
        if (page === undefined) return;
        this.page = page || 'job-log';
      }

      _pageChanged(page) {
        this._updateAjax(page);
        var resolvedPageUrl = this.resolveUrl(page + '.html');
        Polymer.importHref(
          resolvedPageUrl,
          null,
          this._showPage404.bind(this),
          true);
      }

      _updateAjax(page) {
        if (page=="job-log") {
          if(this.$.jobLog.responsed=='0'){
            if(this.connected) return
          }
          this.connected = true;
          this.$.jobLog.resetTemplate();
          this.$.jobLog.$.buildWebSocket.generateRequest();
        }
        if (page=="view-config") {
          this.$.viewConfig.errorText = '';
          this.$.viewConfig.$.configAjax.generateRequest();
        }
      }

      _showPage404() {
        this.page = 'view404';
      }
    }
    window.customElements.define(MainPage.is, MainPage);

  </script>
</dom-module>
